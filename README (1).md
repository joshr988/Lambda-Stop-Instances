# Lab Stop Instances Module

## Overview

Creates a Lambda function that does the following:

* Sets autoscaling groups to an instance count of 0
* Stops any running EC2 instances
* Stops any running RDS instances
* Stops any running Neptune DB clusters
* Stops any running SageMaker notebook instances
* Pauses any running Redshift clusters

Documentation for the function code itself exists in the `lambda/lab_stop_instances/` directory in this repo.

## Deployment

This function should be deployed _in each lab_ by using the `terraform/lab/main.tf` code. When a lab is activated, the function will be created.

## Security

Since this is deployed to each lab, the function and related resource names should include the lowercase word `baseline` in their name to prevent lab users from disabling or editing the function. 

AWS Org policies prevent lab users from creating, deleting, or modifying resources that include the word `baseline`.

## Schedule

Three scheduled triggers are used - one for APAC, one for EMEA, and one for AMER. Each of these are meant to match certain regions. `ap-northeast-1` matches APAC, for example, and `us-west-2` matches AMER.

To set the time for each, first determine the UTC time that matches the hour you want to trigger the shutdown. Lambda triggers only use UTC time.

Once you know the shutdown time in UTC (for example, 7:00 PM in Seattle in the summer = 2:00 AM UTC), use the hour value of the time in the appropriate environment variable named `<REGION>_SHUTDOWN_HOUR`:

```terraform
  environment_variables = {
    AMER_SHUTDOWN_HOUR = 2  # 0200 UTC
    APAC_SHUTDOWN_HOUR = 14 # 1400 UTC
    EMEA_SHUTDOWN_HOUR = 19 # 1900 UTC
  }
```

The module then creates CloudWatch schedule expressions using the above environment variable information as follows:

```
cron(2, <HOUR>, * * ? *)
```

Using the same example, Terraform would generate the following cron schedules:

* AMER: `cron(2, 2, * * ? *)` will run at 2:02 AM  (0202h) UTC every day
* APAC: `cron(2, 14, * * ? *)`, will run at 2:02 PM (1402h) UTC every day
* EMEA: `cron(2, 19, * * ? *)`, will run at 7:02 PM (1902h) UTC every day

The function's Python code includes checks to only stop instances if the function is running during the right shutdown hour.

When the function runs at 02:02 UTC, it will only check for resources in AWS regions that are in AMER (region names that start with `us`, `ca`, or `sa`).

When the function runs at 14:02 UTC, it will only check for resources in AWS regions that are in APAC (region names that start with `ap` or `cn`).

When the function runs at 19:02 UTC, it will only check for resources in AWS regions that are in EMEA (region names that start with `eu` or `me`).

If the region prefix doesn't match any of the expected two-letter combos, the function behaves as if the AWS region were in EMEA.

## Example Usage

```terraform
module "stop_instances_function" {
  source               = "../modules/lab_stop_instances"
  function_dir         = "${path.module}/../../lambda/lab_stop_instances"
  function_name        = "baseline_stop_instances"
  function_description = "Stop EC2, RDS, SageMaker, Neptune, and Redshift instances"
  handler              = "stop_instances.lambda_handler"

  environment_variables = {
    AMER_SHUTDOWN_HOUR = 2  # 0200 UTC
    APAC_SHUTDOWN_HOUR = 14 # 1400 UTC
    EMEA_SHUTDOWN_HOUR = 19 # 1900 UTC
  }

  tags = local.common_tags
}
```

### Features

* Creates a Lambda function with code from a target directory
* This Lambda function is triggered by multiple EventBridge schedule rules based on defined instance shutdown times
* Sends Lambda logs to CloudWatch Log Groups
* Uses Python 3.8
* Runs on each lab

---

_All text below is generated by [terraform-docs](https://github.com/terraform-docs/terraform-docs)_

---

## Requirements

| Name | Version |
|------|---------|
| terraform | ~> 1.0.6 |
| aws | ~> 3.0 |

## Providers

| Name | Version |
|------|---------|
| archive | n/a |
| aws | ~> 3.0 |

## Inputs

| Name | Description | Type | Default | Required |
|------|-------------|------|---------|:--------:|
| function\_dir | Directory relative to the location where `terraform commands` are being run | `string` | n/a | yes |
| function\_name | Name of the Lambda function | `string` | n/a | yes |
| handler | Name of the Lambda handler, in the format <filename>.<python function name> | `string` | n/a | yes |
| environment\_variables | Map of environment variables | `map(string)` | `null` | no |
| function\_description | Description for the Lambda function | `string` | `null` | no |
| runtime | Runtime to use | `string` | `"python3.8"` | no |
| tags | Map of tags in the format `<Key> = <Value` | `map(string)` | `null` | no |
| timeout | Timeout in seconds | `number` | `300` | no |

## Outputs

| Name | Description |
|------|-------------|
| function\_name | Name of the Lambda function |
| lambda\_role\_arn | ARN of the execution role used by Lambda |
